<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Task tracker | Мои задачи</title>
  <link rel="icon" type="image/svg+xml" href="img/logo.svg">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="plugins/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" href="plugins/summernote/summernote-bs4.min.css">
  <link rel="stylesheet" href="css/adminlte.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="hold-transition layout-top-nav">
  <div class="wrapper">
    <nav class="main-header navbar navbar-expand-md navbar-light navbar-white">
      <div class="container-fluid">
        <a href="/" class="navbar-brand">
          <img src="img/logo.svg" alt="Task tracker" class="brand-image">
          <span class="brand-text font-weight-light">Task tracker</span>
        </a>
        <ul class="order-1 order-md-3 navbar-nav navbar-no-expand ml-auto">
          <li class="nav-item dropdown user-menu">
            <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
              <span class="user-name"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
              <li class="user-header bg-primary">
                <p>
                  <span class="user-name"></span>
                  <small class="user-email"></small>
                </p>
              </li>
              <li class="user-footer">
                <a href="#" class="btn btn-default btn-flat float-right logout">Выйти</a>
              </li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="content-wrapper kanban">
      <div class="content-header">
        <div class="container-fluid">
          <h1>Мои задачи</h1>
        </div>
      </div>
      <section class="content pb-3">
        <div class="container-fluid h-100 categories">
          <div class="btn-group-vertical align-self-start">
            <button data-toggle="modal" data-target="#colors" class="btn btn-default" title="Управление цветом"><i class="fas fa-palette"></i></button>
            <button data-toggle="modal" data-target="#categories" class="btn btn-default" title="Добавить категорию"><i class="fas fa-plus"></i></button>
          </div>
          <div class="card card-row card-success">
            <div class="card-header">
              <h3 class="card-title">Выполненные</h3>
            </div>
            <div class="card-body tasks"></div>
          </div>
        </div>
      </section>
    </div>

    <footer class="main-footer">
      <strong>© 2025 <a href="/" target="_blank">Task tracker</a></strong>. Все права защищены.
    </footer>
  </div>

  <div class="modal fade" id="colors">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Управление цветом</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label>Добавленные цвета</label>
          <ul class="d-flex colors-colors">
            <li data-hex="#6c757d" style="color: #6c757d" title="Добавить цвет"><i class="fas fa-plus-square"></i></li>
          </ul>
          <form action="#" method="post" id="colors-form" class="mt-3 colors-hidden">
            <div class="form-group">
              <label for="colors-hex">Цвет</label>
              <input type="color" name="hex" id="colors-hex" class="form-control">
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
          <div>
            <button type="submit" class="btn btn-danger colors-hidden" form="colors-form">Удалить</button>
            <button type="submit" class="btn btn-success colors-hidden" form="colors-form">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="categories">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Управление категорией</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="#" method="post" id="categories-form" class="mt-3">
            <div class="form-group">
              <label for="categories-name">Название</label>
              <input type="text" name="name" id="categories-name" class="form-control">
            </div>
            <div class="form-group">
              <label>Цвет</label>
              <ul class="d-flex categories-colors"></ul>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
          <div>
            <button type="submit" class="btn btn-danger" form="categories-form">Удалить</button>
            <button type="submit" class="btn btn-success" form="categories-form">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tasks">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Управление задачей</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="#" method="post" id="tasks-form" class="mt-3">
            <div class="form-group">
              <label for="tasks-name">Название</label>
              <input type="text" name="name" id="tasks-name" class="form-control">
            </div>
            <div class="form-group">
              <label for="tasks-notes">Записи</label>
              <textarea name="notes" id="tasks-notes" class="summernote"></textarea>
            </div>
            <div class="form-group">
              <label for="tasks-category">Категория</label>
              <select name="category" id="tasks-category" class="custom-select"></select>
            </div>
            <div class="form-group">
              <label>Цвет</label>
              <ul class="d-flex categories-colors"></ul>
            </div>
            <div class="form-group">
              <div class="custom-control custom-switch custom-switch-on-success">
                <input type="checkbox" name="done" value="true" id="tasks-done" class="custom-control-input">
                <label class="custom-control-label" for="tasks-done">Задача выполнена</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
          <div>
            <button type="submit" class="btn btn-danger" form="tasks-form">Удалить</button>
            <button type="submit" class="btn btn-success" form="tasks-form">Сохранить</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="plugins/jquery/jquery.min.js"></script>
  <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
  <script src="plugins/summernote/summernote-bs4.min.js"></script>
  <script src="js/adminlte.min.js"></script>
  <script src="js/api.js"></script>
  <script>
    $(document).ready(function () {
      // Перенаправление, если не залогинен
      if (user === null) {
        window.location.href = "login.html";
      } else {
        $(".user-name").text(user.name);
        $(".user-email").text(user.email);
      }

      // Выход из системы
      $(".logout").click(function () {
        post(api.logout()).then((r) => {
          localStorage.removeItem("user");
          window.location.href = "login.html";
        });
        return false;
      });

      // Управление цветом
      let colors;
      const getColors = async () => {
        if (colors === undefined) {
          colors = new Map();
          await get(api.colors()).then((c) => {
            Object.values(c).forEach((color) => {
              colors.set(color.id, color);
            });
          });
        }
      };
      const drawColors = () => {
        $(".colors-colors [data-id]").remove();
        colors.forEach((color) => {
          $(".colors-colors li:last-child").before(
                  '<li data-id="' +
                  color.id +
                  '" data-hex="' +
                  color.hex +
                  '" style="color: ' +
                  color.hex +
                  '" title="Изменить цвет"><i class="fas fa-square"></i></li>',
          );
        });
      };
      const hideColorsHidden = () => {
        $(".colors-hidden").hide();
      };
      $("#colors").on("show.bs.modal", function () {
        hideColorsHidden();
        getColors().then(() => {
          drawColors();
        });
      });
      $(".colors-colors").on("click", "li", function () {
        const color = $(this),
                id = parseInt(color.attr("data-id")),
                modal = color.parents(".modal"),
                form = modal.find("form");
        if (id > 0) {
          form.attr("data-id", id);
        } else {
          form.removeAttr("data-id");
        }
        form.find('[name="hex"]').val(color.attr("data-hex"));
        removeErrors(form);
        form.show();
        modal.find(".btn-success").show();
        modal.find(".btn-danger").toggle(id > 0);
      });
      $("#colors-form").submit(function (e) {
        const submitter = $(e.originalEvent.submitter),
                id = parseInt($(this).attr("data-id"));
        let url = api.colors();
        if (id > 0) {
          url += "/" + id;
        }
        if (submitter.hasClass("btn-danger")) {
          del(url).then(() => {
            colors.delete(id);
            drawColors();
            hideColorsHidden();
            categories.forEach((category) => {
              if (category.color?.id === id) {
                category.color = null;
              }
              category.tasks.forEach((task) => {
                if (task.color?.id === id) {
                  task.color = null;
                }
              });
            });
            drawCategories();
          });
        } else {
          (id > 0 ? put : post)(url, this).then((color) => {
            colors.set(color.id, color);
            drawColors();
            hideColorsHidden();
            if (id > 0) {
              categories.forEach((category) => {
                if (category.color?.id === id) {
                  category.color.hex = color.hex;
                }
                category.tasks.forEach((task) => {
                  if (task.color?.id === id) {
                    task.color.hex = color.hex;
                  }
                });
              });
              drawCategories();
            }
          });
        }
        return false;
      });

      // Управление категориями
      let categories;
      const getCategories = async () => {
        categories = new Map();
        await get(api.categories()).then((c) => {
          Object.values(c).forEach((category) => {
            const tasks = category.tasks;
            category.tasks = new Map();
            Object.values(tasks).forEach((task) => {
              category.tasks.set(task.id, task);
            });
            categories.set(category.id, category);
          });
        });
      };
      getCategories().then(() => {
        drawCategories();
      });
      const truncateText = (text, maxLength) => {
        text = text?.replace(/<[^>]+>/g, "") ?? "";
        if (text.length > maxLength) {
          return text.slice(0, maxLength - 3) + "...";
        }
        return text;
      };
      const drawTask = (task) => {
        return (
                '<div class="card card-secondary card-outline card-task" data-id="' +
                task.id +
                '"  data-category="' +
                task.category +
                '" style="border-top-color: ' +
                (task.color?.hex ?? "#6c757d") +
                '"><div class="card-header"><h5 class="card-title">' +
                task.name +
                '</h5><div class="card-tools">' +
                '<a href="#" data-toggle="modal" data-target="#tasks" title="Редактировать задачу" class="btn btn-tool"><i class="fas fa-pen"></i></a>' +
                '</div></div><div class="card-body">' +
                truncateText(task.notes, 180) +
                "</div></div>"
        );
      };
      const getLuminance = (hexColor) => {
        const hex = hexColor.replace("#", "");
        const r = parseInt(hex.substr(0, 2), 16) / 255;
        const g = parseInt(hex.substr(2, 2), 16) / 255;
        const b = parseInt(hex.substr(4, 2), 16) / 255;
        return 0.2126 * r + 0.7152 * g + 0.0722 * b;
      };
      const getTextColorForBg = (hexColor) => {
        return getLuminance(hexColor) > 0.5 ? "#000000" : "#ffffff";
      };
      const drawCategories = () => {
        $(".card-category").remove();
        const done = new Map();
        categories.forEach((category) => {
          const bgColor = category.color?.hex ?? "#6c757d";
          $(".card-success")
                  .before(
                          '<div class="card card-row card-category" data-id="' +
                          category.id +
                          '"><div class="card-header" style="background-color: ' +
                          bgColor +
                          "; color: " +
                          getTextColorForBg(bgColor) +
                          '"><h3 class="card-title">' +
                          category.name +
                          '</h3><div class="card-tools card-task" data-category="' +
                          category.id +
                          '">' +
                          '<a href="#" data-toggle="modal" data-target="#tasks" title="Добавить задачу" class="btn btn-tool"><i class="fas fa-plus"></i></a>' +
                          '<a href="#" data-toggle="modal" data-target="#categories" title="Редактировать категорию" class="btn btn-tool"><i class="fas fa-pen"></i></a>' +
                          '</div></div><div class="card-body tasks">' +
                          category.tasks.values().reduce((acc, task) => {
                            if (task.done) {
                              done.set(task.id, task);
                            } else {
                              acc += drawTask(task);
                            }
                            return acc;
                          }, "") +
                          "</div></div>",
                  )
                  .find(".card-body")
                  .html(
                          done.values().reduce((acc, task) => {
                            acc += drawTask(task);
                            return acc;
                          }, ""),
                  );
        });

        // Сортировка задач
        $(".tasks").sortable({
          connectWith: ".tasks",
          items: ".card-task",
          cancel: ".card-task .card-body",
          cursor: "move",
          start: function (element, ui) {
            ui.item.data("index", ui.item.index());
            ui.item.data("category", parseInt(ui.item.parents(".card-category").attr("data-id") ?? 0));
          },
          stop: function (element, ui) {
            const index = ui.item.index(),
                    category = parseInt(ui.item.parents(".card-category").attr("data-id") ?? 0),
                    isCategoryChanged = category !== ui.item.data("category");
            if (category === 0 && !isCategoryChanged) {
              $(element.target).sortable("cancel");
              return;
            }
            if (index !== ui.item.data("index") || isCategoryChanged) {
              const offset = isCategoryChanged
                              ? index - ui.item.siblings(".card-task").length
                              : index - ui.item.data("index"),
                      form = $("<form></form>").prepend(
                              '<input type="text" name="offset" value="' + offset + '">',
                      );
              if (isCategoryChanged) {
                form.prepend('<input type="text" name="category" value="' + category + '">');
              }
              patch(api.tasks() + "/" + ui.item.attr("data-id"), form[0]).then(() => {
                if (isCategoryChanged) {
                  ui.item.attr("data-category", category);
                }
                getCategories();
              });
            }
          },
        });
      };
      const drawCategoriesColors = () => {
        $(".categories-colors").html(
                '<li style="color: #6c757d" title="Выбрать цвет"><label><input type="radio" name="color" value="null" checked><i class="fas fa-square"></i></label></li>',
        );
        colors.forEach((color) => {
          $(".categories-colors").append(
                  '<li style="color: ' +
                  color.hex +
                  '" title="Выбрать цвет"><label><input type="radio" name="color" value="' +
                  color.id +
                  '"><i class="fas fa-square"></i></label></li>',
          );
        });
      };
      const fillFields = (object, form) => {
        Object.entries(object).forEach(([key, value]) => {
          const input = form.find('[name="' + key + '"]'),
                  val = value?.id ?? value;
          if (input.attr("type") === "radio" || input.attr("type") === "checkbox") {
            input.filter('[value="' + val + '"]').prop("checked", true);
          } else if (input.is("select")) {
            input.find('[value="' + val + '"]').prop("selected", true);
          } else if (input.hasClass("summernote")) {
            input.summernote("code", val);
          } else {
            input.val(val);
          }
        });
      };
      $("#categories").on("show.bs.modal", function (e) {
        getColors().then(() => {
          drawCategoriesColors();
          const id = parseInt($(e.relatedTarget).parents(".card-category").attr("data-id")),
                  modal = $(this),
                  form = modal.find("form");
          form[0].reset();
          if (id > 0) {
            form.attr("data-id", id);
            modal.find(".btn-danger").toggle(categories.get(id).tasks.size === 0);
            fillFields(categories.get(id), form);
          } else {
            form.removeAttr("data-id");
            modal.find(".btn-danger").hide();
          }
        });
      });
      $("#categories-form").submit(function (e) {
        const submitter = $(e.originalEvent.submitter),
                id = parseInt($(this).attr("data-id"));
        let url = api.categories();
        if (id > 0) {
          url += "/" + id;
        }
        if (submitter.hasClass("btn-danger")) {
          del(url).then(() => {
            categories.delete(id);
            drawCategories();
            hideModal();
          });
        } else {
          (id > 0 ? put : post)(url, this).then((category) => {
            category.tasks = categories.get(category.id).tasks;
            categories.set(category.id, category);
            drawCategories();
            hideModal();
          });
        }
        return false;
      });

      // Сортировка категорий
      $(".categories").sortable({
        items: ".card-category",
        cancel: ".card-category .card-body",
        cursor: "move",
        start: function (element, ui) {
          ui.item.data("index", ui.item.index());
        },
        update: function (event, ui) {
          const offset = ui.item.index() - ui.item.data("index"),
                  form = $("<form></form>").prepend(
                          '<input type="text" name="offset" value="' + offset + '">',
                  )[0];
          patch(api.categories() + "/" + ui.item.attr("data-id"), form).then(() => {
            getCategories();
          });
        },
      });

      // Управление задачами
      const drawTasksCategory = () => {
        $("#tasks-category").html(
                categories.values().reduce((acc, category) => {
                  acc += '<option value="' + category.id + '">' + category.name + "</option>";
                  return acc;
                }, ""),
        );
      };
      $(".summernote").summernote({
        height: 150,
      });
      $("#tasks").on("show.bs.modal", function (e) {
        getColors().then(() => {
          drawTasksCategory();
          drawCategoriesColors();
          const id = parseInt($(e.relatedTarget).parents(".card-task").attr("data-id")),
                  category = parseInt($(e.relatedTarget).parents(".card-task").attr("data-category")),
                  modal = $(this),
                  form = modal.find("form");
          form[0].reset();
          $(".summernote").summernote("reset");
          if (id > 0) {
            form.attr("data-id", id);
            form.attr("data-category", category);
            modal.find(".btn-danger").show();
            fillFields(categories.get(category).tasks.get(id), form);
          } else {
            form.removeAttr("data-id");
            form.removeAttr("data-category");
            form.find('[name="category"]').val(category);
            modal.find(".btn-danger").hide();
          }
        });
      });

      $("#tasks-form").submit(function (e) {
        const submitter = $(e.originalEvent.submitter),
                id = parseInt($(this).attr("data-id")),
                category = parseInt($(this).attr("data-category"));
        let url = api.tasks();
        if (id > 0) {
          url += "/" + id;
        }
        if (submitter.hasClass("btn-danger")) {
          del(url).then(() => {
            categories.get(category).tasks.delete(id);
            drawCategories();
            hideModal();
          });
        } else {
          (id > 0 ? put : post)(url, this).then((task) => {
            categories.get(task.category).tasks.set(task.id, task);
            if (task.category !== category) {
              categories.get(category).tasks.delete(task.id);
            }
            drawCategories();
            hideModal();
          });
        }
        return false;
      });
    });
  </script>
</body>
</html>
